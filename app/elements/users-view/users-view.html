<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../styles/shared-styles.html">

<dom-module id="users-view">
<template>
    <style include="shared-styles">
        :host {
            display: block;
        }

        paper-menu {
            padding: 0;
        }

        paper-icon-item {
            width: 100%;
            display: block;
            border-bottom: 1px solid #eee;
            padding: 8px;
        }

        iron-icon {
            vertical-align: top;
        }

        iron-selector > * {
            padding: 8px;
        }

        .horizontal-section {
            padding: 0;
        }

        .iron-selected {
            background-color: var(--google-blue-500);
            color: white;
        }

        .item-body {
            display: inline-block;
        }

        paper-dropdown-menu {
            text-align: left;
            margin: auto;
            width: 180px;
        }

        paper-dropdown-menu.letters {
            width: 90px;
        }

        paper-tabs {
            width: 400px;
        }

        .horizontal-section {
            text-align: center;
        }

        .nounderline {

        -
        -paper-input-container-underline: {
            display: none;
        }

        ;
        }
        paper-toggle-button {
            margin-bottom: 40px;
            display: block;
        }

        paper-toggle-button:last-child {
            margin-bottom: 0;
        }

        paper-toggle-button.green {
            --paper-toggle-button-checked-bar-color: var(--paper-green-500);
            --paper-toggle-button-checked-button-color: var(--paper-green-500);
            --paper-toggle-button-checked-ink-color: var(--paper-green-500);
            --paper-toggle-button-unchecked-bar-color: var(--paper-green-900);
            --paper-toggle-button-unchecked-button-color: var(--paper-green-900);
            --paper-toggle-button-unchecked-ink-color: var(--paper-green-900);
        }
    </style>
    <h2 class="page-title">Users</h2>
    <template is="dom-if" if="{{visible}}">
        <paper-material>
            <template is="dom-repeat" items="{{users}}">
                <paper-item id="[[item._id]]"
                            style="border-bottom: 1px solid black; padding-bottom:7px; height:200px;">
                    <iron-icon icon="account-circle" item-icon></iron-icon>
                    <div class="item-body" style="display:inline-block; width:20%;">
                        <div>Username: <span>{{item._id}}</span></div>
                        <!-- Commenting this out for now since the user data is being pulled from mailbox service now.
                        If we want this information added again we'll have to combine the auth + mailbox records manually
                        <div>
                            <small>
                                <span>{{item.firstname}}</span> <span>{{item.lastname}}</span>
                                <span>{{item.email}}</span>
                            </small>
                        </div>-->
                    </div>
                    <div style="display:inline-block; width:20%;" class="horizontal-selection">
                        <paper-dropdown-menu>
                            <iron-selector class="dropdown-content roleSelect" attr-for-selected="name"
                                           >
                                <div on-click="updateUser" name="pm">Project Manager</div>
                                <div on-click="updateUser" name="driver">Driver</div>
                                <div on-click="updateUser" name="scheduler">Scheduler</div>
                                <div on-click="updateUser" name="ip">Insurance Prime</div>
                                <div on-click="updateUser" name="qa">QA Manager</div>
                                <div on-click="updateUser" name="inspector">Inspector</div>
                            </iron-selector>
                        </paper-dropdown-menu>
                    </div>
                    <div class="routesDiv regionSelect" style="display:inline-block; width:20%; height:100%; overflow:auto;">

                      <template is="dom-repeat" items="{{regions}}">
                        <paper-checkbox on-click="updateUser" name$="[[item]]">[[item]]</paper-checkbox><br/>
                      </template>
                    </div>
                    <div style="display:inline-block; width:5%; padding-left: 20px;">
                      <paper-toggle-button on-click="updateUser" class="green toggleButton">On Duty</paper-toggle-button>
                    </div>
            </paper-item>
    </template>
    </paper-material>
</template>
</template>
<script>
    (function () {
        'use strict';
        var poly;

        Polymer({
            is: 'users-view',

            properties: {
                visible: {
                    type: Boolean,
                    notify: true,
                    observer: '_visibleChanged'
                },
                users: {
                    type: Array,
                    notify: true,
                    value: []
                },
                regions: {
                    type: Array,
                    notify: true,
                    value: []
                }
            },

            ready: function () {
                poly = this;
            },

            _visibleChanged: function () {
                if (this.visible) {
                    poly.regions = [];
                    poly.loadRegions();
                }
            },

            updateUser: function (e) {
                setTimeout(function () {
                    var username = typeof e.model.item !== 'string' ? e.model.item._id : e.path[2].getAttribute('id');
                    var regions = [];
                    var regionEntries = poly.$$('#' + username).querySelector('.regionSelect').querySelectorAll('paper-checkbox');
                    for (var i = 0; i < regionEntries.length; i++) {
                        if(regionEntries[i].checked) {
                          regions.push(regionEntries[i].getAttribute('name'));
                        }
                    }
                    var mailbox = {
                      info: {
                        role: poly.$$('#' + username).querySelector('.roleSelect').querySelector('.iron-selected').getAttribute('name'),
                        regions: regions
                      },
                      state: {
                        onDuty: poly.$$('#' + username).querySelector('.toggleButton').getAttribute('checked') !== null
                      }
                    };
                    bridgeit.io.mailbox.updateMailbox({id: username, mailbox: mailbox});
                }, 10);
            },

            loadUsers: function () {
                bridgeit.io.mailbox.findMailboxes().then(function (users) {
                    poly.set('users',users);
                    poly.updateToggles();
                });
            },

            updateToggles: function () {
              for (var i=0; i<poly.users.length; i++) {
                (function(user) {
                  setTimeout(function () {
                    if (user.state.onDuty) {
                      poly.$$('#' + user._id).querySelector('.toggleButton').setAttribute('checked', 'checked');
                    }
                    user.info.regions.forEach(function (region) {
                      var d = poly.$$('#' + user._id).querySelector('.regionSelect').querySelector('[name="' + region + '"]');
                      if(d !== null) {
                        d.setAttribute('checked', 'checked');
                      }
                    });
                    poly.$$('#' + user._id).querySelector('.roleSelect').setAttribute('selected',user.info.role);
                  },10);
                })(poly.users[i]);
              }
            },

            loadRegions: function () {
                bridgeit.io.location.getAllRegions({}).then(function (locations) {
                    locations.forEach(function (location) {
                        try {
                            var id = location.label ? location.label : location._id;
                            poly.push('regions', id);
                        }
                        catch (e) {
                            console.error(e);
                        }
                    });
                    if (poly.users.length === 0) {
                      poly.loadUsers();
                    }
                    else {
                      poly.updateToggles();
                    }
                });
            }
        });
    })();
</script>
</dom-module>
